# SponsoredTransferV2.1 - MySBT Gasless Transfer Service

## ğŸ¯ Overview

**SponsoredTransferV2.1** æ˜¯åŸºäº EIP-7702 çš„æ—  Gas è½¬è´¦æœåŠ¡ï¼Œä½¿ç”¨ **MySBT èº«ä»½éªŒè¯**é˜²æ­¢æ»¥ç”¨ã€‚

### Core Features

- âœ… **SBT é—¨æ§›éªŒè¯**: åªæœ‰ MySBT æŒæœ‰è€…å¯ä»¥ä½¿ç”¨
- âœ… **å®Œå…¨æ—  Gas**: EOA å³ä½¿æ²¡æœ‰ ETH ä¹Ÿèƒ½è½¬è´¦
- âœ… **ETH + ERC20**: æ”¯æŒåŸç”Ÿä»£å¸å’Œ ERC20 ä»£å¸
- âœ… **æ‰¹é‡è½¬è´¦**: å•ç¬”äº¤æ˜“å®Œæˆå¤šä¸ªè½¬è´¦
- âœ… **é˜²æ»¥ç”¨æœºåˆ¶**: é€šè¿‡ SBT é—¨æ§›é™åˆ¶è®¿é—®

## ğŸ“‹ Use Case

### é—®é¢˜
ä¼ ç»Ÿ EOA è½¬è´¦éœ€è¦ï¼š
1. è´¦æˆ·é‡Œæœ‰èµ„äº§ï¼ˆETH/ERC20ï¼‰âœ…
2. **è´¦æˆ·é‡Œæœ‰ ETH æ”¯ä»˜ Gas** âŒ

å¯¹äºæ–°ç”¨æˆ·ï¼š
- æ²¡æœ‰ ETH æ— æ³•å‘é€ä»»ä½•äº¤æ˜“
- é€ æˆ"å†·å¯åŠ¨"é—®é¢˜

### V2.1 è§£å†³æ–¹æ¡ˆ

```
ç”¨æˆ· EOA (0 ETH)
  â†“ æˆæƒ (EIP-7702)
SponsoredTransferV2.1 åˆçº¦
  â†“ éªŒè¯ MySBT
  â†“ æ‰§è¡Œè½¬è´¦ (Relay ä»£ä»˜ Gas)
æ”¶æ¬¾äººæ”¶åˆ°èµ„äº§ âœ…
```

**å…³é”®**: ç”¨æˆ· EOA åªéœ€è¦ï¼š
- âœ… æŒæœ‰ MySBTï¼ˆèº«ä»½å‡­è¯ï¼‰
- âœ… æœ‰èµ„äº§ï¼ˆETH æˆ– ERC20ï¼‰
- âŒ ä¸éœ€è¦ ETH æ”¯ä»˜ Gasï¼

## ğŸ—ï¸ Architecture

### Contract Structure

```solidity
SponsoredTransferDelegationV2_1
â”œâ”€â”€ MySBT Integration (from @aastar/shared-config)
â”‚   â””â”€â”€ MySBT: 0xD1e6BDfb907EacD26FF69a40BBFF9278b1E7Cf5C (Sepolia)
â”‚
â”œâ”€â”€ SBT Verification
â”‚   â”œâ”€â”€ requireSBT() modifier
â”‚   â””â”€â”€ checkSBT(address) view function
â”‚
â”œâ”€â”€ ETH Transfers (SBT required)
â”‚   â”œâ”€â”€ transferETH(to, amount)
â”‚   â””â”€â”€ batchTransfer(recipients[], amounts[])
â”‚
â””â”€â”€ ERC20 Transfers (SBT required)
    â”œâ”€â”€ transferERC20(token, to, amount)
    â””â”€â”€ batchTransferERC20(token, recipients[], amounts[])
```

### MySBT Interface

```solidity
interface IMySBT {
    /// @notice Get user's SBT token ID (0 if none)
    function getUserSBT(address u) external view returns (uint256);

    /// @notice Get SBT balance (0 or 1)
    function balanceOf(address owner) external view returns (uint256);
}
```

## ğŸš€ Quick Start

### 1. Deploy Contract

```bash
# Deploy to Sepolia
forge script script/DeployV2_1.s.sol:DeployV2_1Script \
  --rpc-url $VITE_SEPOLIA_RPC_URL \
  --broadcast \
  --verify

# Output: Contract address
# Update .env with VITE_SPONSORED_TRANSFER_V2_1_ADDRESS=<address>
```

### 2. Verify SBT Ownership

```typescript
import { publicClient } from './config/viem'

// Check if user has MySBT
const mySBTAddress = '0xD1e6BDfb907EacD26FF69a40BBFF9278b1E7Cf5C'
const userAddress = '0x...' // Your EOA

const sbtId = await publicClient.readContract({
  address: mySBTAddress,
  abi: mySBTAbi,
  functionName: 'getUserSBT',
  args: [userAddress],
})

if (sbtId === 0n) {
  console.log('âŒ User does not have MySBT - cannot use gasless service')
} else {
  console.log('âœ… User has MySBT:', sbtId, '- eligible for gasless transfers')
}
```

### 3. EIP-7702 Authorization

```typescript
import { signAuthorization } from 'viem/experimental'

// Step 1: Sign authorization
const authorization = await signAuthorization(walletClient, {
  account: authorizerAccount,
  contractAddress: V2_1_CONTRACT_ADDRESS, // SponsoredTransferV2.1
  chainId: 11155111, // Sepolia
  nonce: await publicClient.getTransactionCount({ address: authorizerAccount.address }),
})

// Step 2: Relay broadcasts transaction
const hash = await relayWalletClient.sendTransaction({
  authorizationList: [authorization],
  to: authorizerAccount.address,
  data: '0x', // V2.1 doesn't need initialize()
  gas: 100000n,
})
```

### 4. Gasless Transfer (No ETH needed!)

```typescript
import { encodeFunctionData } from 'viem'

// User's EOA now has V2.1 code injected
// User has 0 ETH for gas, but has USDC tokens

// Encode ERC20 transfer
const data = encodeFunctionData({
  abi: sponsoredTransferV2_1Abi,
  functionName: 'transferERC20',
  args: [
    USDC_ADDRESS,
    RECIPIENT_ADDRESS,
    parseUnits('100', 6), // 100 USDC
  ],
})

// Relay sends transaction (pays gas)
// User EOA executes transfer (owns USDC)
const hash = await relayWalletClient.sendTransaction({
  to: authorizerAccount.address, // User's EOA
  data,
  gas: 150000n,
})

// âœ… 100 USDC transferred
// âœ… User paid 0 gas
// âœ… Relay paid ~$0.50 in gas
```

## ğŸ“Š Testing

### Run Tests

```bash
# All tests
forge test --match-path test/SponsoredTransferDelegationV2_1.t.sol -vv

# Specific test
forge test --match-test testTransferETH_WithSBT -vvvv

# With gas report
forge test --match-path test/SponsoredTransferDelegationV2_1.t.sol --gas-report
```

### Test Coverage

- âœ… SBT verification (with & without SBT)
- âœ… ETH single transfer
- âœ… ETH batch transfer
- âœ… ERC20 single transfer
- âœ… ERC20 batch transfer
- âœ… View functions (balance, token info)
- âœ… Error cases (no SBT, insufficient balance, etc.)

**Results**: 15/15 tests passing âœ…

## ğŸ” Security

### SBT Verification

Every transfer function uses the `requireSBT` modifier:

```solidity
modifier requireSBT() {
    IMySBT sbtContract = IMySBT(MY_SBT);
    uint256 sbtId = sbtContract.getUserSBT(address(this));

    if (sbtId == 0) {
        emit SBTVerificationFailed(address(this), "No MySBT found");
        revert("User must hold MySBT to use gasless transfers");
    }
    _;
}
```

### Anti-Abuse Mechanisms

1. **SBT Gating**: Only MySBT holders can use the service
2. **Balance Check**: User must own the assets being transferred
3. **No Loops**: All arrays require length validation
4. **Event Logging**: All transfers emit events with SBT status

### MySBT Acquisition

Users must:
- Mint MySBT from: `0xD1e6BDfb907EacD26FF69a40BBFF9278b1E7Cf5C`
- Join AAStar Community
- Stake minimum GToken amount

This ensures only committed community members use the gasless service.

## ğŸ’° Economics

### Cost Analysis

**Traditional EOA Transfer (with gas)**:
- User pays: Transfer value + Gas fee (~$0.50)
- Total: $100.50 to send $100

**V2.1 Gasless Transfer**:
- User pays: Transfer value only ($100)
- Relay pays: Gas fee (~$0.50)
- Total: $100 to send $100 (user perspective)

**Relay Revenue Model**:
1. **Freemium**: Free for MySBT holders (community benefit)
2. **Premium**: Priority gas for paid subscribers
3. **Community Pool**: Gas costs covered by DAO treasury

## ğŸ“„ Contract Interface

### Read Functions

```solidity
// Check if user has MySBT
function checkSBT(address user) external view
    returns (bool hasSBT, uint256 sbtId);

// Get balances
function getBalance() external view returns (uint256);
function getERC20Balance(address token) external view returns (uint256);
function getTokenInfo(address token) external view
    returns (string memory symbol, uint8 decimals);
```

### Write Functions (Require SBT)

```solidity
// ETH transfers
function transferETH(address payable to, uint256 amount) external;
function batchTransfer(
    address payable[] calldata recipients,
    uint256[] calldata amounts
) external;

// ERC20 transfers
function transferERC20(address token, address to, uint256 amount) external;
function batchTransferERC20(
    address token,
    address[] calldata recipients,
    uint256[] calldata amounts
) external;
```

## ğŸ“ Usage Examples

### Example 1: New User Onboarding

```
1. User joins AAStar Community
2. User receives MySBT airdrop
3. User receives 100 USDC airdrop (but 0 ETH)
4. User authorizes V2.1 via EIP-7702
5. User transfers USDC to friend (0 gas cost!)
```

### Example 2: Batch Payroll

```
Company has 100 USDC in EOA (0 ETH)
â†“
Authorize V2.1
â†“
Batch transfer to 10 employees (10 USDC each)
â†“
One transaction, 0 gas cost for company
```

### Example 3: DeFi Integration

```
User wants to stake USDC in DeFi protocol
â†“
User has USDC but 0 ETH
â†“
V2.1 transfers USDC to staking contract
â†“
User earns yield without ever buying ETH
```

## ğŸ“ Configuration

### Environment Variables

```bash
# .env
VITE_SEPOLIA_RPC_URL=https://eth-sepolia.g.alchemy.com/v2/...
VITE_RELAY_PRIVATE_KEY=0x...
VITE_AUTHORIZER_PRIVATE_KEY=0x...

# V2.1 Contract
VITE_SPONSORED_TRANSFER_V2_1_ADDRESS=0x...

# MySBT (from @aastar/shared-config)
VITE_MY_SBT_ADDRESS=0xD1e6BDfb907EacD26FF69a40BBFF9278b1E7Cf5C
```

### Frontend Integration

```typescript
import { TOKEN_ADDRESSES } from '@aastar/shared-config'

const MySBT_ADDRESS = TOKEN_ADDRESSES.mySBT
// 0xD1e6BDfb907EacD26FF69a40BBFF9278b1E7Cf5C

// Check SBT before showing gasless UI
const hasSBT = await checkUserSBT(userAddress)
if (hasSBT) {
  showGaslessTransferUI()
} else {
  showMintSBTPrompt()
}
```

## ğŸ›£ï¸ Roadmap

### v2.1.0 (Current)
- âœ… MySBT verification
- âœ… ETH + ERC20 gasless transfers
- âœ… Batch transfers
- âœ… Comprehensive tests

### v2.2.0 (Planned)
- [ ] Community-specific SBT verification
- [ ] Transfer limits based on SBT tier
- [ ] Gas sponsorship pool
- [ ] Multi-chain support

### v3.0.0 (Future)
- [ ] Any contract call support (not just transfers)
- [ ] Signature-based transfer (meta-transactions)
- [ ] Cross-chain gasless transfers
- [ ] DAO governance integration

## ğŸ“š Resources

- **MySBT Contract**: https://sepolia.etherscan.io/address/0xD1e6BDfb907EacD26FF69a40BBFF9278b1E7Cf5C
- **@aastar/shared-config**: https://github.com/AAStarCommunity/aastar-shared-config
- **EIP-7702 Spec**: https://eips.ethereum.org/EIPS/eip-7702
- **AAStar Community**: https://aastar.io

## ğŸ“„ License

MIT

---

**Built with â¤ï¸ by AAStar Community**
