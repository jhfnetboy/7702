# EIP-7702 æ ¸å¿ƒæ¦‚å¿µæ·±åº¦è§£æ

## ğŸ“‹ ç›®å½•

1. [Relay è§’è‰²æ¾„æ¸…](#relay-è§’è‰²æ¾„æ¸…)
2. [SponsoredTransferDelegation åˆçº¦è§£æ](#sponsoredtransferdelegation-åˆçº¦è§£æ)
3. [å®Œæ•´æ‰§è¡Œæµç¨‹](#å®Œæ•´æ‰§è¡Œæµç¨‹)
4. [æ ¸å¿ƒä¼˜åŠ¿](#æ ¸å¿ƒä¼˜åŠ¿)

---

## ä¸€ã€Relay è§’è‰²æ¾„æ¸…

### 1.1 Relay çš„å®šä¹‰

**Relay = "ä¸Šé“¾äºº" è§’è‰² = ç±»ä¼¼ ERC-4337 çš„ Bundler**

Relay æ˜¯ä¸€ä¸ªæ™®é€šçš„ EOA è´¦æˆ·ï¼Œå……å½“äº¤æ˜“çš„æœ€ç»ˆæäº¤è€…å’Œ gas æ”¯ä»˜æ–¹ã€‚

### 1.2 Relay vs ERC-4337 Bundler å¯¹æ¯”

| ç»´åº¦ | ERC-4337 Bundler | EIP-7702 Relay |
|------|------------------|----------------|
| **è§’è‰²å®šä¹‰** | äº¤æ˜“æ‰“åŒ…è€…å’Œä¸Šé“¾æäº¤äºº | äº¤æ˜“å‘èµ·è€…å’Œä¸Šé“¾æäº¤äºº |
| **ä¸»è¦èŒè´£** | 1. æ”¶é›† UserOperations<br>2. æ‰“åŒ…æˆbundle<br>3. æäº¤åˆ° EntryPoint<br>4. ç”± Paymaster æ”¯ä»˜ gas | 1. å‘èµ·äº¤æ˜“<br>2. ç›´æ¥æäº¤åˆ°é“¾ä¸Š<br>3. è‡ªå·±æ”¯ä»˜ gas |
| **æŠ€æœ¯å¤æ‚åº¦** | é«˜ (éœ€è¦ EntryPoint + Paymaster åŸºç¡€è®¾æ–½) | ä½ (æ™®é€š EOA + ç§é’¥å³å¯) |
| **Gas æ”¯ä»˜** | Paymaster åˆçº¦æ”¯ä»˜ | Relay EOA è‡ªå·±æ”¯ä»˜ |
| **æ˜¯å¦å¿…éœ€** | æ˜¯ (4337æ¶æ„å¿…éœ€) | å¦ (å¯é€‰çš„ä¸šåŠ¡è§’è‰²) |
| **å»ä¸­å¿ƒåŒ–** | å¤šä¸ª Bundler ç«äº‰ | å¯ä»¥æ˜¯ä»»ä½•æ„¿æ„ä»£ä»˜çš„ EOA |

### 1.3 å·¥ä½œæµç¨‹å¯¹æ¯”

#### ERC-4337 æ¶æ„

```
ç”¨æˆ· (Smart Account)
  â†“ ç­¾ç½² UserOperation
Bundler (æ”¶é›†å¤šä¸ª UserOp)
  â†“ æ‰“åŒ…æˆ bundle
EntryPoint åˆçº¦
  â†“ éªŒè¯å¹¶æ‰§è¡Œ
Paymaster åˆçº¦ (æ”¯ä»˜ gas)
  â†“
ç”¨æˆ·å… gas âœ…
```

#### EIP-7702 æ¶æ„

```
ç”¨æˆ· (EOA)
  â†“ ç­¾ç½² Authorization (ç¦»çº¿)
Relay (å¯é€‰)
  â†“ å‘èµ·äº¤æ˜“å¹¶æ”¯ä»˜ gas
é“¾ä¸Š (Authorizer EOA)
  â†“ æ‰§è¡Œæ³¨å…¥çš„åˆçº¦ä»£ç 
ç”¨æˆ·å… gas âœ…
```

### 1.4 æ ¸å¿ƒç›¸ä¼¼ç‚¹

ä¸¤è€…çš„**æœ€ç»ˆç›®æ ‡å®Œå…¨ä¸€è‡´**ï¼šè®©ç”¨æˆ·äº«å—å… gas ä½“éªŒ

```
Bundler (4337):
   â”œâ”€ ç”¨æˆ·ç­¾ç½² UserOperation
   â”œâ”€ Bundler æ”¶é›†å¹¶æ‰“åŒ…
   â”œâ”€ Bundler æäº¤åˆ° EntryPoint
   â”œâ”€ Paymaster æ”¯ä»˜ gas
   â””â”€ ç”¨æˆ·å… gas âœ…

Relay (7702):
   â”œâ”€ ç”¨æˆ·ç­¾ç½² Authorization
   â”œâ”€ Relay ç›´æ¥å‘èµ·äº¤æ˜“
   â”œâ”€ Relay æäº¤åˆ°é“¾ä¸Š
   â”œâ”€ Relay æ”¯ä»˜ gas
   â””â”€ ç”¨æˆ·å… gas âœ…
```

### 1.5 å…³é”®åŒºåˆ«

**åŸºç¡€è®¾æ–½è¦æ±‚**:

```
ERC-4337:
   éœ€è¦å®Œæ•´åŸºç¡€è®¾æ–½:
   â”œâ”€ EntryPoint åˆçº¦ (å·²éƒ¨ç½²)
   â”œâ”€ Paymaster åˆçº¦ (éœ€è¦èµ„é‡‘)
   â”œâ”€ Bundler èŠ‚ç‚¹ (éœ€è¦è¿è¥)
   â””â”€ æ™ºèƒ½åˆçº¦é’±åŒ… (éœ€è¦éƒ¨ç½²)

EIP-7702:
   åªéœ€:
   â”œâ”€ Relay EOA (æ™®é€šè´¦æˆ· + ç§é’¥)
   â”œâ”€ Delegation åˆçº¦ (éƒ¨ç½²ä¸€æ¬¡)
   â””â”€ ç”¨æˆ·çš„ EOA (æ— éœ€ä¿®æ”¹)
```

### 1.6 Relay çš„å¯é€‰æ€§

**å…³é”®ç†è§£**: Relay ä¸æ˜¯æŠ€æœ¯ä¸Šå¿…éœ€çš„ï¼Œè€Œæ˜¯ä¸šåŠ¡ä¸Šå¯é€‰çš„ã€‚

```
æ¨¡å¼ 1: æ²¡æœ‰ Relay (Authorizer è‡ªå·±ç”¨)
   Authorizer:
   â”œâ”€ è‡ªå·±ç­¾ç½² Authorization (executor: 'self')
   â”œâ”€ è‡ªå·±å‘èµ·äº¤æ˜“
   â”œâ”€ è‡ªå·±æ”¯ä»˜ gas âŒ
   â””â”€ äº«å—åˆçº¦åŠŸèƒ½ (æ‰¹é‡è½¬è´¦ç­‰) âœ…

æ¨¡å¼ 2: ä½¿ç”¨ Relay (å… gas ä½“éªŒ)
   Authorizer:
   â”œâ”€ ç­¾ç½² Authorization (ç¦»çº¿ï¼Œå…è´¹)
   â””â”€ ç­‰å¾… Relay ä»£ä¸ºæ‰§è¡Œ

   Relay:
   â”œâ”€ å‘èµ·äº¤æ˜“
   â”œâ”€ æ”¯ä»˜ gas âœ…
   â””â”€ ç”¨æˆ·å… gas âœ…
```

**æ€»ç»“**: Relay çš„å­˜åœ¨æ˜¯ä¸ºäº†æä¾›"å… gas"çš„ç”¨æˆ·ä½“éªŒï¼Œè€Œä¸æ˜¯æŠ€æœ¯ä¸Šçš„å¿…é¡»ç»„ä»¶ã€‚

---

## äºŒã€SponsoredTransferDelegation åˆçº¦è§£æ

### 2.1 æ ¸å¿ƒæœºåˆ¶

**æœ€å…³é”®çš„ç†è§£**:

```solidity
contract SponsoredTransferDelegation {
    // å½“åˆçº¦ä»£ç æ³¨å…¥åˆ° EOA å:
    // - address(this) = è¢«æˆæƒçš„ EOA åœ°å€ (Authorizer)
    // - msg.sender = äº¤æ˜“å‘èµ·è€… (Relay æˆ– Authorizer è‡ªå·±)
    // - ä½™é¢æ¥æº = address(this).balance (Authorizer çš„ ETH)
    // - Gas æ”¯ä»˜ = msg.sender çš„ ETH
}
```

**ç¤ºæ„å›¾**:

```
Authorizer EOA: 0xAAA (ä½™é¢: 1 ETH)
   â†“ EIP-7702 æˆæƒ
æ³¨å…¥åˆçº¦ä»£ç : SponsoredTransferDelegation
   â†“ Relay å‘èµ·äº¤æ˜“
msg.sender = Relay (0xRRR)
address(this) = Authorizer (0xAAA)
   â†“ æ‰§è¡Œ transferETH(0xBBB, 0.1 ETH)
ä» 0xAAA è½¬å‡º 0.1 ETH â†’ 0xBBB
Gas ä» 0xRRR æ‰£é™¤
```

### 2.2 æ ¸å¿ƒå‡½æ•°è¯¦è§£

#### å‡½æ•° 1: `transferETH()` - å•ç¬”è½¬è´¦

```solidity
function transferETH(address payable to, uint256 amount) external {
    // æ­¥éª¤ 1: éªŒè¯æ¥æ”¶åœ°å€
    require(to != address(0), "Invalid recipient address");

    // æ­¥éª¤ 2: éªŒè¯è½¬è´¦é‡‘é¢
    require(amount > 0, "Amount must be greater than 0");

    // æ­¥éª¤ 3: æ£€æŸ¥ EOA ä½™é¢æ˜¯å¦è¶³å¤Ÿ
    // address(this) = Authorizer EOA
    require(address(this).balance >= amount, "Insufficient balance in EOA");

    // æ­¥éª¤ 4: æ‰§è¡Œè½¬è´¦
    // ä» address(this) (Authorizer EOA) è½¬å‡º
    (bool success, ) = to.call{value: amount}("");
    require(success, "Transfer failed");

    // æ­¥éª¤ 5: å‘å‡ºäº‹ä»¶
    // gasPayer = msg.sender (Relay æˆ– Authorizer)
    emit TransferExecuted(address(this), to, amount, msg.sender);
}
```

**æ‰§è¡Œæµç¨‹å›¾**:

```
åœºæ™¯ A: Relay ä»£ä»˜ Gas
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 1. Relay å‘èµ·äº¤æ˜“                    â”‚
â”‚    walletClient.sendTransaction({    â”‚
â”‚      to: authorizer.address,         â”‚
â”‚      data: transferETH(B, 0.01 ETH)  â”‚
â”‚    })                                â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
              â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 2. äº¤æ˜“åˆ°è¾¾ Authorizer EOA           â”‚
â”‚    (å·²æ³¨å…¥åˆçº¦ä»£ç )                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
              â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 3. EVM æ‰§è¡Œ transferETH()            â”‚
â”‚    - address(this) = Authorizer      â”‚
â”‚    - msg.sender = Relay              â”‚
â”‚    - æ£€æŸ¥ Authorizer.balance >= 0.01 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
              â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 4. æ‰§è¡Œè½¬è´¦                          â”‚
â”‚    - ä» Authorizer ä½™é¢æ‰£ 0.01 ETH   â”‚
â”‚    - å‘é€åˆ° B åœ°å€                   â”‚
â”‚    - Gas ä» Relay ä½™é¢æ‰£é™¤           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
              â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 5. å‘å‡ºäº‹ä»¶                          â”‚
â”‚    TransferExecuted(                 â”‚
â”‚      from: Authorizer,               â”‚
â”‚      to: B,                          â”‚
â”‚      amount: 0.01 ETH,               â”‚
â”‚      gasPayer: Relay                 â”‚
â”‚    )                                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

```
åœºæ™¯ B: Authorizer è‡ªå·±ä»˜ Gas
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 1. Authorizer å‘èµ·äº¤æ˜“               â”‚
â”‚    (ä½¿ç”¨ executor: 'self')           â”‚
â”‚    authorizerWallet.sendTransaction({â”‚
â”‚      to: authorizer.address,         â”‚
â”‚      data: transferETH(B, 0.01 ETH)  â”‚
â”‚    })                                â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
              â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 2. æ‰§è¡Œ transferETH()                â”‚
â”‚    - address(this) = Authorizer      â”‚
â”‚    - msg.sender = Authorizer         â”‚
â”‚    - ä» Authorizer ä½™é¢æ‰£ 0.01 ETH   â”‚
â”‚    - Gas ä¹Ÿä» Authorizer æ‰£é™¤        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
              â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 3. å‘å‡ºäº‹ä»¶                          â”‚
â”‚    gasPayer: Authorizer              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

#### å‡½æ•° 2: `batchTransfer()` - æ‰¹é‡è½¬è´¦ â­

**è¿™æ˜¯ä¼ ç»Ÿ EOA æ— æ³•å®ç°çš„æ ¸å¿ƒåŠŸèƒ½ï¼**

```solidity
function batchTransfer(
    address payable[] calldata recipients,  // æ¥æ”¶è€…æ•°ç»„
    uint256[] calldata amounts              // é‡‘é¢æ•°ç»„
) external {
    // æ­¥éª¤ 1: éªŒè¯æ•°ç»„é•¿åº¦åŒ¹é…
    require(recipients.length == amounts.length, "Length mismatch");
    require(recipients.length > 0, "Empty recipients");

    // æ­¥éª¤ 2: è®¡ç®—æ€»é‡‘é¢å¹¶éªŒè¯ä½™é¢
    uint256 totalAmount = 0;
    for (uint256 i = 0; i < amounts.length; i++) {
        totalAmount += amounts[i];
    }
    require(address(this).balance >= totalAmount, "Insufficient balance");

    // æ­¥éª¤ 3: å¾ªç¯æ‰§è¡Œæ¯ç¬”è½¬è´¦
    for (uint256 i = 0; i < recipients.length; i++) {
        require(recipients[i] != address(0), "Invalid recipient");
        require(amounts[i] > 0, "Invalid amount");

        // æ‰§è¡Œè½¬è´¦ - æ‰€æœ‰è½¬è´¦åœ¨åŒä¸€ä¸ªäº¤æ˜“ä¸­ï¼
        (bool success, ) = recipients[i].call{value: amounts[i]}("");
        require(success, "Transfer failed");

        // æ¯ç¬”éƒ½å‘å‡ºäº‹ä»¶
        emit TransferExecuted(address(this), recipients[i], amounts[i], msg.sender);
    }

    // æ­¥éª¤ 4: æ‰¹é‡è½¬è´¦å®Œæˆäº‹ä»¶
    emit BatchTransferExecuted(address(this), totalAmount, recipients.length, msg.sender);
}
```

**æ ¸å¿ƒä¼˜åŠ¿å¯¹æ¯”**:

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚            ä¼ ç»Ÿ EOA æ‰¹é‡è½¬è´¦ (3ä¸ªåœ°å€)                  â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ è½¬è´¦ 0.006 ETH åˆ° 3 ä¸ªåœ°å€ (0.001 + 0.002 + 0.003)     â”‚
â”‚                                                         â”‚
â”‚ äº¤æ˜“ 1: ç­¾å â†’ å‘é€ 0.001 ETH åˆ° A â†’ ç­‰å¾…ç¡®è®¤ â†’ 21000 gas â”‚
â”‚ äº¤æ˜“ 2: ç­¾å â†’ å‘é€ 0.002 ETH åˆ° B â†’ ç­‰å¾…ç¡®è®¤ â†’ 21000 gas â”‚
â”‚ äº¤æ˜“ 3: ç­¾å â†’ å‘é€ 0.003 ETH åˆ° C â†’ ç­‰å¾…ç¡®è®¤ â†’ 21000 gas â”‚
â”‚                                                         â”‚
â”‚ âŒ æ€»è®¡: 3 æ¬¡ç­¾åï¼Œ3 ç¬”äº¤æ˜“ï¼Œ63000 gas                  â”‚
â”‚ âŒ éœ€è¦ç­‰å¾… 3 æ¬¡åŒºå—ç¡®è®¤                                â”‚
â”‚ âŒ å¤±è´¥é£é™©: ä»»ä½•ä¸€ç¬”éƒ½å¯èƒ½å¤±è´¥                         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚      EIP-7702 + SponsoredTransfer æ‰¹é‡è½¬è´¦              â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ è½¬è´¦ 0.006 ETH åˆ° 3 ä¸ªåœ°å€ (0.001 + 0.002 + 0.003)     â”‚
â”‚                                                         â”‚
â”‚ äº¤æ˜“ 1: batchTransfer([A,B,C], [0.001,0.002,0.003])    â”‚
â”‚    â”œâ”€ å†…éƒ¨å¾ªç¯æ‰§è¡Œ 3 æ¬¡ call{value}                    â”‚
â”‚    â”œâ”€ 0.001 ETH â†’ A                                    â”‚
â”‚    â”œâ”€ 0.002 ETH â†’ B                                    â”‚
â”‚    â””â”€ 0.003 ETH â†’ C                                    â”‚
â”‚                                                         â”‚
â”‚ âœ… æ€»è®¡: 0 æ¬¡ç­¾å (Relayä»£ä»˜), 1 ç¬”äº¤æ˜“                â”‚
â”‚ âœ… åªéœ€ç­‰å¾… 1 æ¬¡åŒºå—ç¡®è®¤                                â”‚
â”‚ âœ… åŸå­æ€§: è¦ä¹ˆå…¨éƒ¨æˆåŠŸï¼Œè¦ä¹ˆå…¨éƒ¨å¤±è´¥                    â”‚
â”‚ âœ… Gas èŠ‚çº¦è¯¦è§: GAS-ANALYSIS.md                        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

#### å‡½æ•° 3: `getBalance()` - æŸ¥è¯¢ä½™é¢

```solidity
function getBalance() external view returns (uint256) {
    // è¿”å› address(this) (Authorizer EOA) çš„ä½™é¢
    return address(this).balance;
}
```

**ç”¨é€”**:
- å‰ç«¯æ˜¾ç¤º Authorizer å¯ç”¨ä½™é¢
- éªŒè¯æ˜¯å¦æœ‰è¶³å¤Ÿ ETH è¿›è¡Œè½¬è´¦

---

## ä¸‰ã€å®Œæ•´æ‰§è¡Œæµç¨‹

### 3.1 æµç¨‹å›¾

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    EIP-7702 å®Œæ•´æµç¨‹                        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

æ­¥éª¤ 1: æˆæƒç­¾ç½² (ç¦»çº¿ï¼Œå…è´¹)
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Authorizer (ç”¨æˆ·)                    â”‚
â”‚ â”œâ”€ ä½¿ç”¨ç§é’¥ç­¾ç½² Authorization:       â”‚
â”‚ â”‚  {                                 â”‚
â”‚ â”‚    contractAddress: 0x3bCC...9B8F, â”‚
â”‚ â”‚    chainId: 11155111,              â”‚
â”‚ â”‚    nonce: 0                        â”‚
â”‚ â”‚  }                                 â”‚
â”‚ â””â”€ ç”Ÿæˆç­¾å (r, s, v)                â”‚
â”‚                                      â”‚
â”‚ âš ï¸ æ³¨æ„: è¿™ä¸€æ­¥ä¸ä¸Šé“¾ï¼Œä¸èŠ± gas       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
              â†“
æ­¥éª¤ 2: ä¸Šé“¾æˆæƒ (Relay æˆ– Authorizer å‘èµ·)
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Relay å‘èµ·äº¤æ˜“:                      â”‚
â”‚ sendTransaction({                    â”‚
â”‚   to: Authorizer.address,            â”‚
â”‚   authorizationList: [auth],         â”‚
â”‚   data: initialize(),                â”‚
â”‚   gas: ç”± Relay æ”¯ä»˜ âœ…              â”‚
â”‚ })                                   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
              â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ é“¾ä¸Šæ‰§è¡Œ:                            â”‚
â”‚ â”œâ”€ EVM è¯»å– authorizationList        â”‚
â”‚ â”œâ”€ éªŒè¯ç­¾åæœ‰æ•ˆ                      â”‚
â”‚ â”œâ”€ å°† SponsoredTransfer åˆçº¦ä»£ç      â”‚
â”‚ â”‚  æ³¨å…¥åˆ° Authorizer EOA             â”‚
â”‚ â””â”€ è°ƒç”¨ initialize() å‡½æ•°            â”‚
â”‚                                      â”‚
â”‚ âœ… ç»“æœ: Authorizer EOA ç°åœ¨æœ‰åˆçº¦ä»£ç  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
              â†“
æ­¥éª¤ 3: å•ç¬”è½¬è´¦ (Relay å‘èµ·)
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Relay å‘èµ·äº¤æ˜“:                      â”‚
â”‚ sendTransaction({                    â”‚
â”‚   to: Authorizer.address, â† é‡ç‚¹ï¼  â”‚
â”‚   data: transferETH(B, 0.01 ETH)     â”‚
â”‚ })                                   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
              â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ EVM æ‰§è¡Œæµç¨‹:                        â”‚
â”‚ 1. äº¤æ˜“åˆ°è¾¾ Authorizer EOA           â”‚
â”‚ 2. EVM æ£€æµ‹åˆ°è¯¥åœ°å€æœ‰åˆçº¦ä»£ç         â”‚
â”‚ 3. æ‰§è¡Œ SponsoredTransfer.transferETH()â”‚
â”‚    â”œâ”€ address(this) = Authorizer     â”‚
â”‚    â”œâ”€ msg.sender = Relay             â”‚
â”‚    â”œâ”€ ä» Authorizer ä½™é¢è½¬ 0.01 ETH  â”‚
â”‚    â””â”€ Gas ä» Relay ä½™é¢æ‰£é™¤          â”‚
â”‚ 4. å‘å‡º TransferExecuted äº‹ä»¶        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
              â†“
æ­¥éª¤ 4: æ‰¹é‡è½¬è´¦ (ä¸€æ¬¡æ€§å¤šç¬”ï¼)
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Relay å‘èµ·äº¤æ˜“:                      â”‚
â”‚ sendTransaction({                    â”‚
â”‚   to: Authorizer.address,            â”‚
â”‚   data: batchTransfer(               â”‚
â”‚     [A, B, C],                       â”‚
â”‚     [0.001, 0.002, 0.003]            â”‚
â”‚   )                                  â”‚
â”‚ })                                   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
              â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ EVM æ‰§è¡Œæµç¨‹:                        â”‚
â”‚ 1. éªŒè¯æ€»é‡‘é¢: 0.006 ETH             â”‚
â”‚ 2. éªŒè¯ Authorizer.balance >= 0.006  â”‚
â”‚ 3. å¾ªç¯æ‰§è¡Œ:                         â”‚
â”‚    â”œâ”€ A.call{value: 0.001}() âœ…     â”‚
â”‚    â”œâ”€ B.call{value: 0.002}() âœ…     â”‚
â”‚    â””â”€ C.call{value: 0.003}() âœ…     â”‚
â”‚ 4. æ‰€æœ‰è½¬è´¦åœ¨ä¸€ç¬”äº¤æ˜“ä¸­å®Œæˆï¼        â”‚
â”‚ 5. åªéœ€æ”¯ä»˜ä¸€æ¬¡ gas (Relay)          â”‚
â”‚                                      â”‚
â”‚ âœ… åŸå­æ€§: å…¨éƒ¨æˆåŠŸæˆ–å…¨éƒ¨å¤±è´¥        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 3.2 å…³é”®ç‚¹æ€»ç»“

| å…³é”®ç‚¹ | è¯´æ˜ |
|--------|------|
| **äº¤æ˜“ç›®æ ‡** | æ€»æ˜¯å‘é€åˆ° Authorizer.addressï¼Œè€Œä¸æ˜¯åˆçº¦åœ°å€ |
| **ä»£ç ä½ç½®** | åˆçº¦ä»£ç æ³¨å…¥åˆ° Authorizer EOAï¼Œè€Œä¸æ˜¯ç‹¬ç«‹éƒ¨ç½² |
| **ä½™é¢æ¥æº** | è½¬è´¦é‡‘é¢ä» Authorizer EOA ä½™é¢æ‰£é™¤ |
| **Gas æ”¯ä»˜** | ç”± msg.sender (Relay æˆ– Authorizer) æ”¯ä»˜ |
| **åŸå­æ€§** | æ‰¹é‡è½¬è´¦è¦ä¹ˆå…¨éƒ¨æˆåŠŸï¼Œè¦ä¹ˆå…¨éƒ¨å¤±è´¥ |

---

## å››ã€æ ¸å¿ƒä¼˜åŠ¿

### 4.1 vs ä¼ ç»Ÿ EOA

| åŠŸèƒ½ | ä¼ ç»Ÿ EOA | EIP-7702 EOA |
|------|----------|--------------|
| **å•ç¬”è½¬è´¦** | âœ… åŸç”Ÿæ”¯æŒ | âœ… åˆçº¦å¢å¼º |
| **æ‰¹é‡è½¬è´¦** | âŒ éœ€è¦å¤šç¬”äº¤æ˜“ | âœ… ä¸€ç¬”äº¤æ˜“å®Œæˆ |
| **å… Gas** | âŒ å¿…é¡»è‡ªå·±æ”¯ä»˜ | âœ… Relay å¯ä»£ä»˜ |
| **å¯ç¼–ç¨‹æ€§** | âŒ æ— æ³•æ‰©å±• | âœ… æ³¨å…¥åˆçº¦é€»è¾‘ |
| **å‘åå…¼å®¹** | âœ… å®Œå…¨å…¼å®¹ | âœ… ä¿æŒ EOA ç‰¹æ€§ |

### 4.2 vs ERC-4337

| ç»´åº¦ | ERC-4337 | EIP-7702 |
|------|----------|----------|
| **è´¦æˆ·ç±»å‹** | æ™ºèƒ½åˆçº¦è´¦æˆ· (å…¨æ–°) | EOA (ä¸´æ—¶å¢å¼º) |
| **éƒ¨ç½²æˆæœ¬** | éœ€è¦éƒ¨ç½² AA é’±åŒ… | æ— éœ€éƒ¨ç½² |
| **åŸºç¡€è®¾æ–½** | EntryPoint + Paymaster + Bundler | Relay (å¯é€‰) |
| **å¤æ‚åº¦** | é«˜ | ä½ |
| **å‘åå…¼å®¹** | ä¸å…¼å®¹ç°æœ‰ EOA | å®Œå…¨å…¼å®¹ |

### 4.3 å®é™…åº”ç”¨åœºæ™¯

1. **DApp å… Gas ä½“éªŒ**
   - DApp è¿è¥æ–¹ä½œä¸º Relay
   - ç”¨æˆ·æ— éœ€æŒæœ‰ ETH å³å¯ä½¿ç”¨
   - é™ä½æ–°ç”¨æˆ·é—¨æ§›

2. **æ‰¹é‡æ“ä½œ**
   - å·¥èµ„å‘æ”¾ (ä¸€æ¬¡å‘é€ç»™å¤šä¸ªå‘˜å·¥)
   - ç©ºæŠ•åˆ†å‘ (ä¸€æ¬¡å‘é€ç»™å¤šä¸ªåœ°å€)
   - èµ„é‡‘å½’é›† (åå‘æ‰¹é‡)

3. **DAO æ²»ç†**
   - DAO é‡‘åº“ä½œä¸º Relay
   - æˆå‘˜æŠ•ç¥¨ã€æ‰§è¡Œææ¡ˆå… Gas
   - æé«˜æ²»ç†å‚ä¸åº¦

4. **é’±åŒ…äº§å“**
   - é’±åŒ…æœåŠ¡å•†æä¾› Relay æœåŠ¡
   - ç”¨æˆ·äº«å—å… Gas ä½“éªŒ
   - å·®å¼‚åŒ–ç«äº‰ä¼˜åŠ¿

---

## äº”ã€æŠ€æœ¯è¦ç‚¹

### 5.1 executor: 'self' å‚æ•°

å½“ Authorizer è‡ªå·±å‘èµ·äº¤æ˜“æ—¶ï¼Œéœ€è¦è®¾ç½®æ­¤å‚æ•°ï¼š

```typescript
const authorization = await walletClient.signAuthorization({
  account: authorizer,
  contractAddress: delegationAddress,
  executor: 'self', // å…³é”®ï¼
})
```

**åŸå› **:
- EIP-7702 è¦æ±‚ `authorization.nonce` å¿…é¡»æ˜¯ `transaction.nonce + 1`
- å½“ Authorizer è‡ªå·±æ‰§è¡Œæ—¶ï¼Œtransaction.nonce ä¼šé€’å¢
- `executor: 'self'` å‘Šè¯‰ Viem æ­£ç¡®è®¡ç®— nonce

### 5.2 address(this) vs msg.sender

**æ°¸è¿œè®°ä½**:

```solidity
// åœ¨æ³¨å…¥çš„åˆçº¦ä»£ç ä¸­:
address(this)  = Authorizer EOA åœ°å€ (ä½™é¢æ¥æº)
msg.sender     = äº¤æ˜“å‘èµ·è€… (Gas æ”¯ä»˜æ–¹)

// ç¤ºä¾‹:
// Authorizer: 0xAAA (ä½™é¢: 1 ETH)
// Relay: 0xRRR (ä½™é¢: 0.1 ETH)

// Relay å‘èµ·è½¬è´¦ 0.5 ETH:
address(this).balance  // 1 ETH (Authorizer çš„ä½™é¢)
msg.sender             // 0xRRR (Relay åœ°å€)

// è½¬è´¦å:
// Authorizer: 0.5 ETH (æ‰£é™¤è½¬è´¦é‡‘é¢)
// Relay: 0.1 - gas (æ‰£é™¤ gas è´¹ç”¨)
```

### 5.3 æ’¤å›æˆæƒ

å‘é€æˆæƒåˆ°é›¶åœ°å€å³å¯æ’¤å›ï¼š

```typescript
const revoke = await walletClient.signAuthorization({
  account: authorizer,
  contractAddress: '0x0000000000000000000000000000000000000000',
})

await walletClient.sendTransaction({
  authorizationList: [revoke],
  to: authorizer.address,
})
```

æ’¤å›åï¼ŒAuthorizer EOA æ¢å¤ä¸ºæ™®é€š EOAã€‚

---

## å…­ã€æ€»ç»“

### EIP-7702 çš„æœ¬è´¨

> **é€šè¿‡ä¸´æ—¶æ³¨å…¥åˆçº¦ä»£ç ï¼Œè®© EOA è·å¾—æ™ºèƒ½åˆçº¦çš„èƒ½åŠ›ï¼ŒåŒæ—¶ä¿æŒ EOA çš„å‘åå…¼å®¹æ€§ã€‚**

### Relay çš„æœ¬è´¨

> **Relay æ˜¯ä¸€ä¸ªå¯é€‰çš„ä¸šåŠ¡è§’è‰²ï¼Œä½œä¸º"ä¸Šé“¾äºº"ä»£æ›¿ç”¨æˆ·å‘èµ·äº¤æ˜“å¹¶æ”¯ä»˜ gasï¼Œæä¾›"å… Gas"çš„ç”¨æˆ·ä½“éªŒã€‚**

### SponsoredTransferDelegation çš„æœ¬è´¨

> **é€šè¿‡æ‰¹é‡æ“ä½œç­‰åˆçº¦é€»è¾‘ï¼Œèµ‹äºˆ EOA ä¼ ç»Ÿè´¦æˆ·æ— æ³•å®ç°çš„åŠŸèƒ½ï¼ŒåŒæ—¶ä¿è¯ç”¨æˆ·æ„å›¾çš„æ­£ç¡®æ‰§è¡Œã€‚**

---

## å‚è€ƒèµ„æ–™

- [EIP-7702 è§„èŒƒ](https://eips.ethereum.org/EIPS/eip-7702)
- [Viem å®˜æ–¹æ–‡æ¡£ - EIP-7702](https://viem.sh/experimental/eip7702)
- [é¡¹ç›®åˆçº¦åœ°å€](https://sepolia.etherscan.io/address/0x3bCC84C21BA32Dba8F3BE86F1E498778918e9B8F)
